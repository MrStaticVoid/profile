#!/usr/bin/env zsh

SELF="$0"
source "$(dirname "$(readlink -f "$SELF")")/lib.zsh" "$SELF"

main() {
    if get_state > /dev/null; then
        timeout 5 "$SELF" wait
    else
        set_state 1
    fi

    nmcli --terse device status | head -1 | IFS=: read device type devstate connection rest

    if [[ $type == 'wifi' ]]; then
        icon="$(fontawesome "\uf1eb")"

        case "$devstate" in
            'connected')
                signal="$(iw dev "$device" link | awk '/signal:/ { print $2 $3 }')"
                segment "${icon} ${signal}"
                ;;

            'connecting'*)
                segment "${icon} ..."
                ;;

            *)
                ;;
        esac
    fi
}

case "$1" in
    'monitor')
        start_monitor_loop nmcli device monitor
        ;;

    'wait')
        get_event > /dev/null
        ;;

    *)
        main
        ;;
esac
