#!/usr/bin/env zsh

SELF="$0"
source "$(dirname "$(readlink -f "$SELF")")/lib.zsh" "$SELF"

main() {
    local state="$(get_state)"

    if [[ $state == 'update' ]]; then
        timeout 5 "$SELF" wait
    elif [[ $state != '' ]]; then
        get_event > /dev/null
    fi

    state='ok'

    nmcli --terse device status | head -1 | IFS=: read device type devstate connection rest

    if [[ $type == 'wifi' ]]; then
        icon="$(fontawesome "\uf1eb")"

        case "$devstate" in
            'connected')
                state='update'
                signal="$(iw dev "$device" link | awk '/signal:/ { print $2 $3 }')"
                segment "${icon} ${signal}"
                ;;

            'connecting'*)
                segment "${icon} ..."
                ;;

            *)
                ;;
        esac
    fi

    set_state "$state"
}

case "$1" in
    'monitor')
        start_monitor_loop nmcli device monitor
        ;;

    'wait')
        get_event > /dev/null
        ;;

    *)
        main
        ;;
esac
