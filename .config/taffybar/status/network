#!/usr/bin/env zsh

source "$(dirname "$0")/lib.zsh" "$0"

if get_state > /dev/null; then
    ( timeout 5 nmcli monitor & print -n "$! " ) | while read pid rest; do
        kill "$pid"
    done
fi

nm_status="$(nmcli -terse device status)"
head -1 <<< "$nm_status" | IFS=: read device type devstate connection rest

if [[ $type == 'wifi' ]]; then
    icon="$(fontawesome 'ï‡«')"

    case "$devstate" in
        'connected')
            signal="$(iw dev "$device" link | awk '/signal:/ { print $2 $3 }')"
            segment "${icon} ${signal}"
            ;;

        'connecting'*)
            segment "${icon} ..."
            ;;

        *)
            ;;
    esac
fi

set_state 1
