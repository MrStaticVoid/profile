#!/usr/bin/env zsh
#
# Bitwarden CLI container wrapper
#
# Behave like the 'bw' Bitwarden CLI command, but invoke the container
# built at https://gitlab.james.tl/nest/tools/bitwarden-cli instead.
#

<% if @facts['profile'] && @facts['profile']['cpu'] -%>
IMAGE='nest/tools/bitwarden-cli:<%= @facts['profile']['cpu'] %>'

if podman image inspect "$IMAGE" >& /dev/null; then
    # Let the password prompt and color output work on real terminals
    [[ -t 1 ]] && tty_args='--tty'

    # Fetch the session token from systemd as written by tools like bw-type
    if [[ ! $BW_SESSION ]]; then
        eval "$(systemctl --user show-environment | grep '^BW_SESSION=')"
        export BW_SESSION
    fi

    # Initialize the configuration with the correct server and file permissions
    if [[ $(stat -c '%a' "${HOME}/.config/Bitwarden CLI" 2>/dev/null) != '700' ]]; then
        rm -rf "${HOME}/.config/Bitwarden CLI"
        podman run --rm -v "${HOME}/.config:/root/.config" "$IMAGE" bw config server vault.thesatelliteoflove.net && print
    fi

    # Run the thing
    exec podman run --rm --interactive $tty_args -e BW_SESSION -v "${HOME}/.config/Bitwarden CLI:/root/.config/Bitwarden CLI" "$IMAGE" bw "$@"
else
    print "Pull ${IMAGE}"
    exit 1
fi
<% else -%>
print "Bitwarden CLI is not supported on this host" >&2
exit 1
<% end -%>

# vim: filetype=zsh
