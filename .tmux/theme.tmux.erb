#!/usr/bin/env zsh
#
# theme.tmux
#
# Try to determine the actual terminal in which the session is attached
# and set colors and status bar appearance based on the available
# capabilities.
#
# This theme is loosely modeled off of my custom Vim Airline tabline theme.
#

# Add TERM to the default list of variables to update on session attachment.
# This lets me make configuration decisions based on the terminal in which the
# session is (most recently) attached.
if [[ ! $(tmux show -g update-environment) =~ '(^|\s)TERM(\s|$)' ]]; then
    tmux set -ag update-environment ' TERM'
fi

# Grab and export the current session TERM setting
eval $(tmux show-environment -s TERM)

<% require 'colorscheme'
cs = ColorScheme.new -%>
if (( terminfo[colors] >= 256 )); then
    # Konsole doesn't support configuring the Base16 colors > 16
    if [[ $TERM == 'konsole-256color' ]]; then
<% cs.colors_by_base.each do |c| -%>
        base<%= c.base %>='#<%= c.hex %>'
<% end -%>
    else
<% cs.colors_by_base.each do |c| -%>
        base<%= c.base %>='colour<%= c.ansi %>'
<% end -%>
    fi
elif (( terminfo[colors] >= 16 )); then
<% cs.colors_by_base(16).each do |c| -%>
    base<%= c.base %>='colour<%= c.ansi %>'
<% end -%>
else
<% cs.colors_by_base(8).each do |c| -%>
    base<%= c.base %>='colour<%= c.ansi %>'
<% end -%>
fi

tmux set -g status-style "bg=${base01}"
tmux set -g status-left-style "bg=magenta,fg=${base01}"
tmux set -g status-right ''
tmux setw -g window-status-separator ''
tmux setw -g window-status-format ' #I: #W#F '
tmux setw -g window-status-current-format ' #I: #W#F '
tmux setw -g window-status-current-style "bg=blue,fg=${base01},bold"
tmux setw -g window-status-activity-style "bg=green,fg=${base01}"
tmux setw -g window-status-bell-style "bg=yellow,fg=${base01}"

if [[ $TERM == *256color ]]; then
    # This is not strictly related to the theme, since I'm going through the
    # trouble of figuring out the real terminal here anyway, might as well
    # set this here too.
    #
    # Note: 'default-terminal' is a server level option which can't be set
    # on a per-session basis.
    # See: https://groups.google.com/forum/#!topic/tmux-users/f5YQieR9jhI
    tmux set -g default-terminal tmux-256color

    tmux set -g status-left ' #[bold]#S#[nobold] #[reverse]î‚° '
    tmux setw -g window-status-last-style "bg=${base02}"
else
    tmux set -g default-terminal tmux

    tmux set -g status-left " #S #[reverse]> "
    tmux setw -g window-status-last-style "bold"
fi
