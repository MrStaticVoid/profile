#!/usr/bin/env zsh
#
# term.tmux
#
# Try to determine the actual terminal in which the session is attached
# and set colors and status bar appearance based on the available
# capabilities.
#
# The theme is loosely modeled off of my custom Vim Airline tabline theme.
#

# Add TERM to the default list of variables to update on session attachment.
# This lets me make configuration decisions based on the terminal in which the
# session is (most recently) attached.
if [[ ! $(tmux show -g update-environment) =~ '(^|\s)TERM(\s|$)' ]]; then
    tmux set -ag update-environment ' TERM'
fi

# Grab and export the current session TERM variable.  Prefer the session
# variable over the global variable.
eval $(tmux show-environment -gs TERM)
eval $(tmux show-environment -s TERM)

tmux_term='tmux'

<% require 'colorscheme'
cs = ColorScheme.new -%>
if [[ $TERM == *truecolor* ]]; then
    tmux_term+='-truecolor'
<% cs.colors_by_base.each do |c| -%>
    base<%= c.base %>='#<%= c.hex %>'
<% end -%>
    tmux set -g status-right-style "fg=${base00}"
    tmux setw -g window-status-last-style "bg=${base02}"
elif (( terminfo[colors] >= 256 )); then
    tmux_term+='-256color'
<% cs.colors_by_base.each do |c| -%>
    base<%= c.base %>='colour<%= c.ansi %>'
<% end -%>
    tmux set -g status-right-style "fg=${base00}"
    tmux setw -g window-status-last-style "bg=${base02}"
elif (( terminfo[colors] >= 16 )); then
<% cs.colors_by_base(16).each do |c| -%>
    base<%= c.base %>='colour<%= c.ansi %>'
<% end -%>
    tmux set -g status-right-style "fg=colour8"
    tmux setw -g window-status-last-style "bold"
else
<% cs.colors_by_base(8).each do |c| -%>
    base<%= c.base %>='colour<%= c.ansi %>'
<% end -%>
    tmux set -g status-right-style "fg=colour8"
    tmux setw -g window-status-last-style "bold"
fi

# Appearance settings that apply to all terminal types
tmux set -g status-style "bg=${base01}"
tmux set -g status-left-length 100
tmux set -g status-right "v$(< ~/.version) "
tmux setw -g window-status-separator ''
tmux setw -g window-status-format ' #I: #W#F '
tmux setw -g window-status-current-format ' #I: #W#F '
tmux setw -g window-status-current-style "bg=blue,fg=${base01},bold"
tmux setw -g window-status-activity-style "bg=green,fg=${base01}"
tmux setw -g window-status-bell-style "bg=yellow,fg=${base01}"

# Per-terminal settings
if [[ $TERM == *powerline* ]]; then
    tmux_term+='-powerline'
    separator='î‚°'
else
    separator='>'
fi

# Detect if we're running in another tmux session and set prefix and
# appearance accordingly
if [[ $TERM == tmux* ]]; then
    tmux unbind C-b; tmux set -g prefix C-a; tmux bind C-a send-prefix
    session_color='magenta'
else
    tmux unbind C-a; tmux set -g prefix C-b; tmux bind C-b send-prefix
    session_color='cyan'
fi

tmux set -g status-left-style "bg=${session_color},fg=${base01}"
tmux set -g status-left " #[bold]#S#[nobold] #[reverse]${separator} "

# 'tmux_term' is built up based on the outside terminal capabilities and is
# one of:
#
# * tmux
# * tmux-powerline
# * tmux-256color
# * tmux-256color-powerline
# * tmux-truecolor
# * tmux-truecolor-powerline
#
tmux set -g default-terminal "$tmux_term"
